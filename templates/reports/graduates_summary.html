{% extends 'base.html' %}
{% load static %}
{% block title %}تقرير شامل للخريجين{% endblock %}
{% block extra_css %}
<style>
.stats-box {background: #f8f9ff; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(102,126,234,0.08);}
.stats-title {font-size: 1.2rem; font-weight: 700; color: #2d3748; margin-bottom: 1rem;}
.stats-value {font-size: 2.2rem; font-weight: 800; color: #667eea;}
.table thead {background: linear-gradient(90deg, #667eea, #764ba2); color: white;}
.export-btns {margin-bottom: 1.5rem; text-align: left;}
.filter-form {margin-bottom: 2rem; background: #f1f5f9; border-radius: 12px; padding: 1rem;}
</style>
{% endblock %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4 gradient-text"><i class="bi bi-people-fill me-2"></i> تقرير شامل للخريجين</h2>
    <!-- نموذج التصفية وأزرار التصدير -->
    <form method="get" class="filter-form row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label">الكلية</label>
            <input type="text" name="college" class="form-control" placeholder="أدخل اسم الكلية" value="{{ request.GET.college }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">القسم</label>
            <input type="text" name="major" class="form-control" placeholder="أدخل اسم القسم" value="{{ request.GET.major }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">سنة التخرج</label>
            <input type="number" name="graduation_year" class="form-control" placeholder="مثال: 2024" value="{{ request.GET.graduation_year }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> عرض الإحصائيات</button>
        </div>
        <div class="col-md-2 export-btns">
            <a href="?export=pdf{{ request.GET.urlencode|yesno:'&,' }}" class="btn btn-danger me-2" target="_blank"><i class="bi bi-file-earmark-pdf"></i> PDF</a>
            <a href="?export=excel{{ request.GET.urlencode|yesno:'&,' }}" class="btn btn-success me-2" target="_blank"><i class="bi bi-file-earmark-excel"></i> Excel</a>
            <button onclick="window.print();return false;" class="btn btn-secondary"><i class="bi bi-printer"></i> طباعة</button>
        </div>
    </form>
    <!-- تهنئة وعدد الخريجين -->
    <div class="alert alert-success text-center">نهنئ جميع الخريجين في الجامعة! عددهم: <b>{{ total }}</b></div>
    <!-- إحصائيات متقدمة -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-box text-center">
                <div class="stats-title">استلموا الاستبيان</div>
                <div class="stats-value">{{ survey_sent }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box text-center">
                <div class="stats-title">لم يستلموا الاستبيان</div>
                <div class="stats-value">{{ survey_not_sent }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box text-center">
                <div class="stats-title">أجابوا على الاستبيان</div>
                <div class="stats-value">{{ survey_answered }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box text-center">
                <div class="stats-title">معدل التوظيف</div>
                <div class="stats-value">{{ employment_rate }}%</div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-box text-center">
                <div class="stats-title">راضون عن جودة التعليم</div>
                <div class="stats-value">{{ satisfied_education }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-box text-center">
                <div class="stats-title">غير راضين عن البرامج</div>
                <div class="stats-value">{{ unsatisfied_programs }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-box text-center">
                <div class="stats-title">أهم 3 اقتراحات</div>
                <div class="stats-value">
                  <ul style="list-style:none;padding:0;">
                    {% for s in top_suggestions %}
                      <li>{{ s.suggestion }} <span class="badge bg-secondary">{{ s.count }}</span></li>
                    {% empty %}<li>لا يوجد اقتراحات</li>{% endfor %}
                  </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- إحصائيات حسب النوع وسنة التخرج -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="stats-box text-center">
                <div class="stats-title">حسب النوع</div>
                {% for g in by_gender %}
                    <div>{{ g.gender|default:'غير محدد' }}: <strong>{{ g.count }}</strong></div>
                {% empty %}<div>لا يوجد بيانات</div>{% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="stats-box text-center">
                <div class="stats-title">حسب سنة التخرج</div>
                {% for y in by_year %}
                    <div>{{ y.graduation_year|default:'-' }}: <strong>{{ y.count }}</strong></div>
                {% empty %}<div>لا يوجد بيانات</div>{% endfor %}
            </div>
        </div>
    </div>
    <!-- أكثر التخصصات تخرجًا -->
    <div class="card mb-4">
        <div class="card-header bg-gradient-primary text-white">
            <i class="bi bi-bar-chart me-2"></i> أكثر التخصصات تخرجًا
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead><tr><th>التخصص</th><th>عدد الخريجين</th></tr></thead>
                <tbody>
                {% for m in by_major %}
                    <tr><td>{{ m.major|default:'-' }}</td><td>{{ m.count }}</td></tr>
                {% empty %}<tr><td colspan="2">لا يوجد بيانات</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- جدول الخريجين -->
    <div class="card">
        <div class="card-header bg-gradient-info text-white">
            <i class="bi bi-list-ul me-2"></i> قائمة الخريجين (أول 50)
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead><tr><th>#</th><th>الاسم</th><th>التخصص</th><th>سنة التخرج</th><th>الجنس</th></tr></thead>
                <tbody>
                {% for grad in graduates|slice:":50" %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{% if grad.full_name %}{{ grad.full_name }}{% elif grad.first_name or grad.last_name %}{{ grad.first_name }} {{ grad.last_name }}{% else %}-{% endif %}</td>
                        <td>{{ grad.major|default:'-' }}</td>
                        <td>{{ grad.graduation_year|default:'-' }}</td>
                        <td>{{ grad.gender|default:'-' }}</td>
                    </tr>
                {% empty %}<tr><td colspan="5">لا يوجد خريجون</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
